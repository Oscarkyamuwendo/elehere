name: Deploy to Railway

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Verify Railway Setup
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Testing Railway CLI connection..."
          
          # Check CLI version
          railway --version
          
          # Create railway.json with your project ID
          echo '{"project": "e6c8c94c-e29d-46bb-8a9b-d1452845618e"}' > railway.json
          
          # Test if we can list services (retry on failure)
          echo "Testing connection to Railway..."
          for i in {1..3}; do
            if railway services 2>/dev/null; then
              echo "✅ Connection successful"
              break
            else
              echo "Attempt $i failed, retrying in 5 seconds..."
              sleep 5
            fi
          done
      
      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "Starting deployment..."
          
          # Deploy with retry logic
          for attempt in {1..3}; do
            echo "Deployment attempt $attempt..."
            
            if railway up --service=elehere --detach; then
              echo "✅ Deployment successful!"
              exit 0
            else
              echo "Attempt $attempt failed"
              
              if [ $attempt -lt 3 ]; then
                echo "Waiting 10 seconds before retry..."
                sleep 10
              fi
            fi
          done
          
          echo "❌ All deployment attempts failed"
          
          # Try alternative command
          echo "Trying alternative deployment method..."
          railway deploy --service=elehere --detach || echo "Alternative method also failed"
          
          # Final exit with error
          exit 1